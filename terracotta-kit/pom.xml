<?xml version="1.0" encoding="UTF-8"?>
<!-- Apache Maven 2 POM generated by Apache Ivy http://ant.apache.org/ivy/ 
  Apache Ivy version: 2.2.0 20100923230623 -->
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">

  <modelVersion>4.0.0</modelVersion>

  <parent>
    <groupId>org.terracotta</groupId>
    <artifactId>terracotta-parent</artifactId>
    <version>3.8.0-SNAPSHOT</version>
    <relativePath>../terracotta-parent</relativePath>
  </parent>

  <groupId>org.terracotta.internal</groupId>
  <artifactId>terracotta-kit</artifactId>
  <packaging>pom</packaging>
  <name>terracotta-kit</name>

  <properties>
    <toolkit.api>1.5</toolkit.api>
    <toolkit.version>6.0.0-SNAPSHOT</toolkit.version>
    <ehcache.version>2.7.0-SNAPSHOT</ehcache.version>
    <quartz.version>3.0.0-SNAPSHOT</quartz.version>
    <terracotta-session.version>3.0.0-SNAPSHOT</terracotta-session.version>

    <skip.deploy>true</skip.deploy>
    <skip.testjar>true</skip.testjar>
    <kit.edition>opensource</kit.edition>
    <ee.suffix/>
    <packaging>dir</packaging>
    <kit.name>${terracotta.artifactId}-${project.version}</kit.name>
    <rootDir>${project.build.directory}/${kit.name}</rootDir>
    <skip.schema>true</skip.schema>
    <no.extra>false</no.extra>
    <gt.kit>false</gt.kit>    

    <terracotta.artifactId>terracotta${ee.suffix}</terracotta.artifactId>
    <terracotta.jarname>${terracotta.artifactId}-${project.version}.jar</terracotta.jarname>
    <toolkit.artifactId>terracotta-toolkit-${toolkit.api}-runtime${ee.suffix}</toolkit.artifactId> 
    <ehcache.artifactId>ehcache-kit</ehcache.artifactId>
    <quartz.artifactId>quartz-kit</quartz.artifactId>

    <terracotta.license>LICENSE.txt</terracotta.license>
  </properties>

  <dependencies>
    <dependency>
      <groupId>org.terracotta</groupId>
      <artifactId>${terracotta.artifactId}</artifactId>
      <version>${project.version}</version>
    </dependency>

    <!-- for packaging purpose -->
    <dependency>
      <groupId>org.terracotta.internal</groupId>
      <artifactId>build-data</artifactId>
      <version>${project.version}</version>
      <scope>provided</scope>
    </dependency>

    <dependency>
      <groupId>org.terracotta</groupId>
      <artifactId>${toolkit.artifactId}</artifactId>
      <version>${toolkit.version}</version>
      <scope>provided</scope>
    </dependency>       

    <dependency>
      <groupId>org.terracotta</groupId>
      <artifactId>tcconfig</artifactId>
      <classifier>docflex</classifier>
      <version>${tcconfig.version}</version><!--$NO-MVN-MAN-VER$-->
      <type>zip</type>
      <scope>provided</scope>
    </dependency>

    <!-- ehcache -->
    <dependency>
      <groupId>net.sf.ehcache</groupId>
      <artifactId>${ehcache.artifactId}</artifactId>
      <version>${ehcache.version}</version>
      <classifier>distribution</classifier>
      <type>tar.gz</type>
      <scope>provided</scope>
      <exclusions>
        <exclusion>
          <groupId>com.sun</groupId>
          <artifactId>tools</artifactId>
        </exclusion>
      </exclusions>
    </dependency>     

    <!-- quartz -->
    <dependency>
      <groupId>org.quartz-scheduler</groupId>
      <artifactId>${quartz.artifactId}</artifactId>
      <version>${quartz.version}</version>
      <classifier>distribution</classifier>
      <type>tar.gz</type>      
      <scope>provided</scope>
    </dependency>

    <!-- express session -->
    <dependency>
      <groupId>org.terracotta.session</groupId>
      <artifactId>terracotta-session</artifactId>
      <version>${terracotta-session.version}</version>
      <scope>provided</scope>
    </dependency>
  </dependencies>

  <profiles>
    <!-- ********************************************************************************** -->
    <!--   profile to build Enterprise Terracotta kit. Need to be used with 'kit' profile   -->    
    <!-- ********************************************************************************** -->  
    <profile>
      <id>enterprise</id>
      <properties>
        <kit.edition>enterprise</kit.edition>
        <ee.suffix>-ee</ee.suffix>
        <ehcache.artifactId>ehcache-ee-kit</ehcache.artifactId>
        <quartz.artifactId>quartz-ee-kit</quartz.artifactId>
        <terracotta.license>TERRACOTTA-TRIAL-LICENSE.txt</terracotta.license>
      </properties>
    </profile>

    <!-- ********************************************************************************** -->
    <!--   profile to build Enterprise Terracotta -gt kit. Need to be used with 'kit' profile   -->    
    <!-- ********************************************************************************** -->  
    <profile>
      <id>gt</id>
      <properties>
        <gt.kit>true</gt.kit>
        <kit.name>${terracotta.artifactId}-gt-${project.version}</kit.name>
      </properties>
    </profile>    

    <!-- ******************************************************************* -->
    <!--   profile to exclude extra packaging of ehcache, quartz, sessions   -->    
    <!-- ******************************************************************* -->     
    <profile>
      <id>no-extra</id>
      <properties>
        <no.extra>true</no.extra>
      </properties>
    </profile>    

    <!-- ********************************************** -->
    <!--   profile to build opensource Terracotta kit   -->    
    <!-- ********************************************** -->    
    <profile>
      <id>kit</id>
      <build>
        <plugins>      
          <plugin>
            <groupId>com.github.goldin</groupId>
            <artifactId>copy-maven-plugin</artifactId>
            <version>${copy-maven-plugin.version}</version>
            <executions>
              <!-- assemble kit content -->
              <execution>
                <id>preparing-terracotta-kit</id>
                <phase>prepare-package</phase>
                <goals>
                  <goal>copy</goal>
                </goals>
                <configuration>
                  <groovyConfig>
                    <classpath>${project.basedir}/src/scripts</classpath>
                  </groovyConfig>        
                  <verbose>false</verbose>
                  <resources>
                    <!-- prepare skeleton structure of the kit -->
                    <resource>
                      <runIf>{{ new File( project.build.directory, "${kit.name}" ).isDirectory() }}</runIf>
                      <directory>${rootDir}</directory>
                      <includes>
                        <include>**/**</include>
                      </includes>
                      <clean>true</clean>
                      <cleanEmptyDirectories>true</cleanEmptyDirectories>
                    </resource>            
                    <resource>
                      <targetPath>${rootDir}</targetPath>
                      <directory>${basedir}/src/packaging/opensource</directory>
                      <preservePath>true</preservePath>
                    </resource>
                    <resource>
                      <runIf>{{ "${kit.edition}" == "enterprise" }}</runIf>
                      <targetPath>${rootDir}</targetPath>
                      <directory>${basedir}/src/packaging/enterprise</directory>
                      <preservePath>true</preservePath>
                    </resource>
                    <resource>
                      <runIf>{{ "${kit.edition}" == "enterprise" }}</runIf>
                      <directory>${rootDir}</directory>
                      <includes>
                        <include>LICENSE.txt</include>
                      </includes>
                      <clean>true</clean>
                    </resource>                    

                    <!-- schema -->
                    <resource>
                      <runIf>{{ "${no.extra}" != "true" }}</runIf>
                      <targetPath>${rootDir}/config-samples/schema</targetPath>
                      <dependency>
                        <groupId>org.terracotta</groupId>
                        <artifactId>tcconfig</artifactId>
                        <classifier>docflex</classifier>
                        <type>zip</type>
                      </dependency>
                      <unpack>true</unpack>
                      <preservePath>true</preservePath>
                      <dependenciesAtM2>true</dependenciesAtM2>
                    </resource>            

                    <!-- populate lib folder -->
                    <resource>
                      <targetPath>${rootDir}/lib</targetPath>
                      <dependency>
                        <excludeScope>provided</excludeScope>
                        <excludeArtifactIds>${terracotta.artifactId},build-data,stax-api,native-tool,ant,mockito-all,ant-launcher,junit,linked-child-process
                        </excludeArtifactIds>
                      </dependency>
                      <dependenciesAtM2>true</dependenciesAtM2>
                    </resource>


                    <!-- build data -->
                    <resource>
                      <targetPath>${rootDir}/lib/resources</targetPath>
                      <dependency>
                        <groupId>org.terracotta.internal</groupId>
                        <artifactId>build-data</artifactId>
                      </dependency>
                      <zipEntries>
                        <zipEntry>build-data.txt</zipEntry>
                      </zipEntries>
                      <unpack>true</unpack>              
                    </resource>

                    <!-- tookit -->
                    <resource>
                      <runIf>{{ "${no.extra}" != "true" }}</runIf>
                      <targetPath>${rootDir}/common</targetPath>
                      <dependency>
                        <groupId>org.terracotta</groupId>
                        <artifactId>${toolkit.artifactId}</artifactId>
                      </dependency>
                      <dependenciesAtM2>true</dependenciesAtM2>
                    </resource>
                    <resource>
                      <runIf>{{ "${no.extra}" != "true" }}</runIf>
                      <targetPath>${rootDir}/common/docs/javadoc</targetPath>
                      <dependency>
                        <groupId>org.terracotta</groupId>
                        <artifactId>${toolkit.artifactId}</artifactId>
                        <classifier>javadoc</classifier>
                      </dependency>
                      <unpack>true</unpack>
                      <dependenciesAtM2>true</dependenciesAtM2>
                    </resource>            

                    <!-- console -->
                    <resource>
                      <runIf>{{ "${no.extra}" != "true" &amp;&amp; "${kit.edition}" == "enterprise" }}</runIf>
                      <targetPath>${rootDir}/console</targetPath>
                      <dependency>
                        <groupId>com.terracotta</groupId>
                        <artifactId>management-client-war</artifactId>
                        <version>${management.version}</version>
                        <type>war</type>
                      </dependency>
                      <dependenciesAtM2>true</dependenciesAtM2>
                    </resource>

                    <!-- ehcache -->
                    <resource>
                      <runIf>{{ "${no.extra}" != "true" }}</runIf>
                      <targetPath>${rootDir}</targetPath>
                      <dependency>
                        <groupId>net.sf.ehcache</groupId>
                        <artifactId>${ehcache.artifactId}</artifactId>
                        <classifier>distribution</classifier>
                        <type>tar.gz</type>
                      </dependency>
                      <dependenciesAtM2>true</dependenciesAtM2>
                      <unpack>true</unpack>
                      <process>Util.processEhcacheDistribution(project)</process>              
                    </resource>
                    <resource>
                      <runIf>{{ "${no.extra}" != "true" }}</runIf>
                      <directory>${rootDir}/ehcache</directory>
                      <include>**/licenses/**</include>
                      <clean>true</clean>
                      <cleanEmptyDirectories>true</cleanEmptyDirectories>
                      <failIfNotFound>false</failIfNotFound>
                    </resource>
                    <resource>
                      <runIf>{{ "${no.extra}" != "true" }}</runIf>
                      <targetPath>${rootDir}/ehcache</targetPath>
                      <file>${ehcache-core.readme.url}</file>
                    </resource>
                    <resource>
                      <runIf>{{ "${no.extra}" != "true" }}</runIf>
                      <targetPath>${rootDir}/ehcache</targetPath>
                      <file>${ehcache-core.quickstart.url}</file>
                    </resource>
                    <resource>
                      <runIf>{{ "${no.extra}" != "true" }}</runIf>
                      <targetPath>${rootDir}/ehcache</targetPath>
                      <file>${ehcache-core.tcschema.url}</file>
                      <destFileName>ehcache.xml</destFileName>
                    </resource>
                    <resource>
                      <runIf>{{ "${no.extra}" != "true" }}</runIf>
                      <targetPath>${rootDir}/ehcache/licenses</targetPath>
                      <file>${ehcache-core.tclicense.url}</file>
                    </resource>
                    
                    <!-- move tmc to the root, https://jira.terracotta.org/jira/browse/DEV-7354 -->
                     <resource>
                      <targetPath>${rootDir}/tmc</targetPath>
                      <directory>${rootDir}/ehcache/tmc</directory>
                      <preservePath>true</preservePath>
                      <failIfNotFound>false</failIfNotFound>
                      <!-- move does not really work; it will move the files at the root, but not the dirs... -->
                      <!-- move>true</move-->
                    </resource>
                    <resource>
                      <directory>${rootDir}/ehcache/tmc/</directory>
                      <clean>true</clean>
                      <cleanEmptyDirectories>true</cleanEmptyDirectories>
                      <failIfNotFound>false</failIfNotFound>
                    </resource>
                    <resource>
                      <targetPath>${rootDir}/bin</targetPath>
                      <directory>${rootDir}/tmc/bin</directory>
                      <includes>
                       <include>add-tc-agent.*</include>
                       <include>keychain.*</include>
                       <include>usermanagement.*</include>
                       <include>management-cli-common.*</include>
                      </includes>
                      <failIfNotFound>false</failIfNotFound>
                    </resource>
                    
                    <!-- quartz -->
                    <resource>
                      <runIf>{{ "${no.extra}" != "true" }}</runIf>
                      <targetPath>${rootDir}</targetPath>
                      <dependency>
                        <groupId>org.quartz-scheduler</groupId>
                        <artifactId>${quartz.artifactId}</artifactId>
                        <classifier>distribution</classifier>
                        <type>tar.gz</type>
                      </dependency>
                      <dependenciesAtM2>true</dependenciesAtM2>
                      <unpack>true</unpack>
                      <process>Util.processQuartzDistribution(project)</process>              
                    </resource>
                    <resource>
                      <runIf>{{ "${no.extra}" != "true" }}</runIf>
                      <directory>${rootDir}/quartz</directory>
                      <include>**/licenses/**</include>
                      <clean>true</clean>
                      <cleanEmptyDirectories>true</cleanEmptyDirectories>
                      <failIfNotFound>false</failIfNotFound>
                    </resource>                    

                    <!-- session express -->
                    <resource>
                      <runIf>{{ "${no.extra}" != "true" }}</runIf>
                      <targetPath>${rootDir}/sessions</targetPath>
                      <dependency>
                        <groupId>org.terracotta.session</groupId>
                        <artifactId>terracotta-session</artifactId>
                      </dependency>
                      <dependenciesAtM2>true</dependenciesAtM2>
                    </resource>

                    <!-- 1. remove build-data.txt from terracotta jar and rename it to tc.jar 
                         2. set execution permissions for scripts and library files
                         3. apply -gt kit changes
                    -->
                    <resource>
                      <targetPath>${rootDir}/lib</targetPath>
                      <dependency>
                        <groupId>org.terracotta</groupId>
                        <artifactId>${terracotta.artifactId}</artifactId>
                      </dependency>
                      <dependenciesAtM2>true</dependenciesAtM2>
                      <process>Util.processTerracottaJar(project, files.first(), "lib")
                               Util.setPermission(project)
                               if (project.properties['gt.kit'] == "true") {
                                 Util.processEnterpriseGtKit(project)
                               }
                      </process>
                    </resource>                    
                  </resources>
                </configuration>                
              </execution>
            </executions>
          </plugin>
        </plugins>
      </build>
    </profile>

    <!-- *********************************************** -->
    <!--   profile to make Izpack installer of the kit   -->    
    <!-- *********************************************** -->     
    <profile>
      <id>installer</id>
      <properties>
        <izpack.src.directory>${project.basedir}/src/packaging/izpack</izpack.src.directory>
        <izpack.output.directory>${project.build.directory}/izpack</izpack.output.directory>
        <izpack.install.xml>${izpack.output.directory}/install.xml</izpack.install.xml>
        <izpack.installer.output>${project.build.directory}/${kit.name}-installer.jar</izpack.installer.output>
        <izpack.basedir>${rootDir}</izpack.basedir>
      </properties>
      <build>
        <plugins>
          <plugin>
            <groupId>com.github.goldin</groupId>
            <artifactId>copy-maven-plugin</artifactId>
            <version>${copy-maven-plugin.version}</version>
            <executions>
              <execution>
                <id>prepare-izpack-installer</id>
                <phase>prepare-package</phase>
                <goals>
                  <goal>copy</goal>
                </goals>
                <configuration>
                  <groovyConfig>
                    <classpath>${project.basedir}/src/scripts</classpath>
                  </groovyConfig>        
                  <verbose>false</verbose>  
                  <resources>
                    <!-- Copy and filter the IzPack shortcut files. -->
                    <resource>
                      <targetPath>${izpack.output.directory}</targetPath>
                      <directory>${izpack.src.directory}</directory>
                      <include>*.xml</include>
                      <filtering>true</filtering>
                      <encoding>UTF-8</encoding>
                    </resource>
                    <resource>
                      <targetPath>${izpack.output.directory}</targetPath>
                      <directory>${izpack.src.directory}/resources</directory>
                      <include>*.*</include>
                      <filtering>false</filtering>
                    </resource>
                    <resource>
                      <targetPath>${izpack.output.directory}</targetPath>
                      <directory>${izpack.src.directory}/resources/${kit.edition}</directory>
                      <include>*.*</include>
                      <filtering>false</filtering>
                    </resource>
                  </resources>
                </configuration>
              </execution>
            </executions>
          </plugin>
          <plugin>
            <groupId>org.codehaus.gmaven</groupId>
            <artifactId>gmaven-plugin</artifactId>
            <version>${gmaven-plugin.version}</version>
            <executions>
              <execution>
                <id>generate-install-xml</id>
                <phase>prepare-package</phase>
                <goals>
                  <goal>execute</goal>
                </goals>
                <configuration>
                  <source>${izpack.src.directory}/InstallXmlBuilder.groovy</source>
                </configuration>
              </execution>
              <execution>
                <id>create-izpack-installer</id>
                <phase>package</phase>
                <goals>
                  <goal>execute</goal>
                </goals>
                <configuration>
                  <source>${project.basedir}/src/scripts/IzpackPackage.groovy</source>
                </configuration>
              </execution>
            </executions>
            <dependencies>
              <dependency>
                <groupId>org.apache.ant</groupId>
                <artifactId>ant</artifactId>
                <version>1.8.2</version>
              </dependency>
              <dependency>
                <groupId>org.terracotta</groupId>
                <artifactId>izpack-standalone-compiler</artifactId>
                <version>4.3.0</version>
              </dependency>
            </dependencies>
          </plugin>
        </plugins>
      </build>
    </profile>

    <!-- *********************************************** -->
    <!--   profile to make a patch tarball from the kit  -->    
    <!-- *********************************************** -->     
    <profile>
      <id>patch</id>
      <properties>
        <patch.def.file>src/packaging/patch/patch-def.xml</patch.def.file>
      </properties>
      <build>
        <plugins>
          <plugin>
            <groupId>org.codehaus.gmaven</groupId>
            <artifactId>gmaven-plugin</artifactId>
            <version>${gmaven-plugin.version}</version>
            <executions>
              <execution>
                <id>create-patch-tarball</id>
                <phase>package</phase>
                <goals>
                  <goal>execute</goal>
                </goals>
                <configuration>         
                  <source>
                    File kitDir = new File("${rootDir}")
                    File patchDefFile = new File("${patch.def.file}")
                    def patchDef = new XmlSlurper().parse(patchDefFile)
                    def patchLevel = patchDef.level.text()
                    def patchName = "${kit.name}-patch${patchLevel}"
                    def patchFiles = patchDef.files.collect { it.text() }

                    ant.tar(destfile: "${project.build.directory}/${patchName}.tar.gz", longfile: "gnu", compression: "gzip") {
                      patchFiles.each { file -&gt;
                        tarfileset(dir: "${kitDir}") {
                          include(name: file)
                        }
                      }
                    } 
                </source>
              </configuration>
            </execution>
          </executions>
        </plugin>            
      </plugins>
    </build>
  </profile>

  <!-- *************************************** -->
  <!--   profile to make tar ball of the kit   -->    
  <!-- *************************************** -->     
  <profile>
    <id>tarball</id>
    <build>
      <plugins>
        <plugin>
          <groupId>org.codehaus.gmaven</groupId>
          <artifactId>gmaven-plugin</artifactId>
          <version>${gmaven-plugin.version}</version>
          <executions>
            <execution>
              <id>create-tarball</id>
              <phase>package</phase>
              <goals>
                <goal>execute</goal>
              </goals>
              <configuration>         
                <source>
                    def srcdir = new File(project.basedir, "target/${kit.name}") 
                    ant.tar(destfile: "${srcdir}.tar.gz", longfile: "gnu", compression: "gzip") {
                      tarfileset(dir: "${srcdir}", prefix: "${kit.name}", excludes: "**/.placeholder,**/bin/**,**/lib/**,**/*.sh,**/*.bat")
                      tarfileset(dir: "${srcdir}", prefix: "${kit.name}", includes: "**/bin/**,**/lib/**,**/*.sh,**/*.bat", filemode: "755")
                    } 
                </source>
              </configuration>
            </execution>
          </executions>
        </plugin>            
      </plugins>
    </build>
  </profile>    
</profiles>

</project>
